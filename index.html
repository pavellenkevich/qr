<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR — простой генератор</title>
  <meta name="description" content="Минималистичный генератор QR-кодов: PNG, JPG или SVG" />
  <meta name="theme-color" content="#0f0f14" />
  <style>
    :root {
      --bg: #0f0f14;
      --card: #17171e;
      --muted: #8a8a94;
      --text: #eaeaf0;
      --accent: #3b82f6;
      --border: #262631;
      --shadow: 0 8px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Inter, Arial, "Noto Sans", sans-serif;
      background: radial-gradient(1200px 600px at 50% -100px, #1e293b22, transparent), var(--bg);
      color: var(--text);
      display: grid; place-items: center; padding: 24px;
    }
    .wrap { width: 100%; max-width: 820px; }
    header { text-align: center; margin-bottom: 18px; }
    h1 { font-size: 22px; margin: 0 0 6px; font-weight: 700; }
    p.sub { margin: 0; color: var(--muted); font-size: 14px; }

    .card {
      background: linear-gradient(180deg,#1a1a22, #14141a);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px; display: grid; gap: 16px;
    }
    form { display: grid; gap: 12px; }

    .row { display: grid; gap: 10px; }
    @media (min-width: 760px) {
      .row { grid-template-columns: 1fr auto auto; align-items: end; }
    }

    label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    input[type="text"], select, input[type="number"] {
      width: 100%;
      background: #0f0f14;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 12px; padding: 12px 14px; font-size: 15px;
      outline: none; transition: border-color .2s ease;
    }
    input[type="text"]:focus, select:focus, input[type="number"]:focus { border-color: #3b82f6aa; }

    .controls { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 10px; }
    .controls .hide { display: none; }

    .btns { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    button, .ghost {
      appearance: none; border: none; cursor: pointer; user-select: none;
      padding: 12px 16px; border-radius: 12px; font-weight: 600; font-size: 15px;
      transition: transform .05s ease, background .2s ease, opacity .2s ease; line-height: 1;
    }
    button.primary { background: var(--accent); color: white; }
    button.secondary { background: #262637; color: #e7e7ee; }
    button:active { transform: translateY(1px); }
    button[disabled] { opacity: .5; cursor: not-allowed; }

    .status { font-size: 12px; color: var(--muted); min-height: 1em; }

    .preview {
      border: 1px dashed var(--border); border-radius: 12px; min-height: 220px;
      display: grid; place-items: center; overflow: hidden; background: #0b0b10; padding: 12px;
    }
    .preview > * { max-width: 100%; height: auto; }
    .hint { font-size: 12px; color: var(--muted); }

    .footer { text-align: center; color: var(--muted); font-size: 12px; margin-top: 6px; }
    a.link { color: #9ab7ff; text-decoration: none; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Минималистичный QR‑генератор</h1>
      <p class="sub">Вставь ссылку → выбери формат и стиль → скачай QR</p>
    </header>

    <div class="card">
      <form id="qrForm">
        <div>
          <label for="data">Ссылка / текст</label>
          <input id="data" type="text" placeholder="https://пример.домен/страница" autocomplete="off" required />
        </div>

        <div class="controls">
          <div>
            <label for="format">Формат</label>
            <select id="format">
              <option value="png">PNG</option>
              <option value="jpg">JPG</option>
              <option value="svg">SVG</option>
            </select>
          </div>
          <div id="rasterBlock">
            <label for="size">Размер (px) — для PNG/JPG</label>
            <input id="size" type="number" min="128" max="4096" step="1" value="1024" />
          </div>
          <div>
            <label for="filename">Имя файла (без расширения)</label>
            <input id="filename" type="text" placeholder="qr-code" value="qr-code" />
          </div>
          <div>
            <label for="style">Стиль модулей</label>
            <select id="style">
              <option value="squares">Квадраты</option>
              <option value="dots">Кружки</option>
              <option value="diamonds">Ромбики</option>
            </select>
          </div>
        </div>

        <div class="btns">
          <button type="submit" class="primary" id="genBtn">Сгенерировать</button>
          <button type="button" class="secondary" id="dlBtn" disabled>Скачать</button>
          <span class="status" id="status"></span>
        </div>
        <div class="hint">ECC: M · Тихая зона: 4 модуля · Цвет: чёрный на белом</div>
      </form>

      <div class="preview" id="preview">
        <span class="hint">Здесь будет превью QR‑кода</span>
      </div>
    </div>

    <div class="footer">Без серверов, всё делается в браузере.</div>
  </div>

  <!-- Лёгкая библиотека для матрицы QR -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>

  <script>
  ;(() => {
    const $ = (sel) => document.querySelector(sel)
    const dataEl = $('#data')
    const formatEl = $('#format')
    const sizeEl = $('#size')
    const styleEl = $('#style')
    const filenameEl = $('#filename')
    const rasterBlock = $('#rasterBlock')
    const form = $('#qrForm')
    const preview = $('#preview')
    const genBtn = $('#genBtn')
    const dlBtn = $('#dlBtn')
    const statusEl = $('#status')

    let lastBlobUrl = null
    let lastFormat = null
    let lastFilename = null

    function setStatus(msg) { statusEl.textContent = msg || '' }

    function sanitizeFilename(name) {
      return (name || 'qr-code').replace(/[^a-zA-Z0-9-_\.]+/g, '-').replace(/^-+|-+$/g, '') || 'qr-code'
    }

    function toggleRasterControls() {
      const isRaster = formatEl.value === 'png' || formatEl.value === 'jpg'
      rasterBlock.style.display = isRaster ? 'block' : 'none'
    }
    formatEl.addEventListener('change', toggleRasterControls)
    toggleRasterControls()

    function ensureLibReady() {
      if (typeof window.qrcode !== 'function') {
        throw new Error('Библиотека QR ещё не загрузилась')
      }
    }

    function buildQRMatrix(text) {
      const ECC = 'M' // L, M, Q, H
      const qr = window.qrcode(0, ECC)
      qr.addData(text)
      qr.make()
      return qr
    }

    // ===== Рендер растр
    function drawCanvas(qr, targetSize, style) {
      const modules = qr.getModuleCount()
      const quiet = 4 // quiet zone in modules
      const scale = Math.max(1, Math.floor(targetSize / (modules + 2 * quiet)))
      const size = scale * (modules + 2 * quiet)

      const canvas = document.createElement('canvas')
      canvas.width = size
      canvas.height = size
      const ctx = canvas.getContext('2d')

      // фон — белый (особенно важно для JPG)
      ctx.fillStyle = '#fff'
      ctx.fillRect(0, 0, size, size)

      ctx.fillStyle = '#000'
      const offset = scale * quiet

      if (style === 'dots') {
        const r = Math.floor(scale * 0.5) // радиус кружка
        for (let rIdx = 0; rIdx < modules; rIdx++) {
          for (let cIdx = 0; cIdx < modules; cIdx++) {
            if (qr.isDark(rIdx, cIdx)) {
              const cx = offset + cIdx * scale + scale / 2
              const cy = offset + rIdx * scale + scale / 2
              ctx.beginPath()
              ctx.arc(cx, cy, r, 0, Math.PI * 2)
              ctx.fill()
            }
          }
        }
      } else if (style === 'diamonds') {
        for (let rIdx = 0; rIdx < modules; rIdx++) {
          for (let cIdx = 0; cIdx < modules; cIdx++) {
            if (qr.isDark(rIdx, cIdx)) {
              const x = offset + cIdx * scale
              const y = offset + rIdx * scale
              const cx = x + scale/2, cy = y + scale/2
              ctx.save()
              ctx.translate(cx, cy)
              ctx.rotate(Math.PI / 4) // 45°
              ctx.fillRect(-scale/2, -scale/2, scale, scale)
              ctx.restore()
            }
          }
        }
      } else {
        for (let rIdx = 0; rIdx < modules; rIdx++) {
          for (let cIdx = 0; cIdx < modules; cIdx++) {
            if (qr.isDark(rIdx, cIdx)) {
              ctx.fillRect(offset + cIdx * scale, offset + rIdx * scale, scale, scale)
            }
          }
        }
      }

      return canvas
    }

    // ===== Рендер SVG
    function makeCustomSVG(qr, style) {
      const modules = qr.getModuleCount()
      const quiet = 4
      const cell = 8
      const size = (modules + 2 * quiet) * cell
      const xmlns = 'http://www.w3.org/2000/svg'
      const svg = document.createElementNS(xmlns, 'svg')
      svg.setAttribute('viewBox', `0 0 ${size} ${size}`)
      svg.setAttribute('width', `${size}`)
      svg.setAttribute('height', `${size}`)
      svg.setAttribute('xmlns', xmlns)

      // фон
      const bg = document.createElementNS(xmlns, 'rect')
      bg.setAttribute('fill', '#fff')
      bg.setAttribute('x', '0'); bg.setAttribute('y', '0')
      bg.setAttribute('width', String(size)); bg.setAttribute('height', String(size))
      svg.appendChild(bg)

      const group = document.createElementNS(xmlns, 'g')
      group.setAttribute('fill', '#000')
      svg.appendChild(group)

      const offset = quiet * cell
      for (let r = 0; r < modules; r++) {
        for (let c = 0; c < modules; c++) {
          if (!qr.isDark(r, c)) continue
          const x = offset + c * cell
          const y = offset + r * cell
          if (style === 'dots') {
            const circ = document.createElementNS(xmlns, 'circle')
            circ.setAttribute('cx', String(x + cell/2))
            circ.setAttribute('cy', String(y + cell/2))
            circ.setAttribute('r', String(Math.floor(cell * 0.5)))
            group.appendChild(circ)
          } else if (style === 'diamonds') {
            const g = document.createElementNS(xmlns, 'g')
            g.setAttribute('transform', `translate(${x + cell/2} ${y + cell/2}) rotate(45) translate(${-cell/2} ${-cell/2})`)
            const rect = document.createElementNS(xmlns, 'rect')
            rect.setAttribute('x', '0'); rect.setAttribute('y', '0')
            rect.setAttribute('width', String(cell)); rect.setAttribute('height', String(cell))
            g.appendChild(rect)
            group.appendChild(g)
          } else {
            const rect = document.createElementNS(xmlns, 'rect')
            rect.setAttribute('x', String(x))
            rect.setAttribute('y', String(y))
            rect.setAttribute('width', String(cell))
            rect.setAttribute('height', String(cell))
            group.appendChild(rect)
          }
        }
      }
      return svg
    }

    function revokeLastUrl() {
      if (lastBlobUrl) {
        URL.revokeObjectURL(lastBlobUrl)
        lastBlobUrl = null
      }
    }

    function setPreview(node) {
      preview.innerHTML = ''
      preview.appendChild(node)
    }

    async function canvasToBlobUrl(canvas, mime) {
      return new Promise((resolve) => {
        if (canvas.toBlob) {
          canvas.toBlob((blob) => {
            resolve(URL.createObjectURL(blob))
          }, mime, 0.92)
        } else {
          const dataUrl = canvas.toDataURL(mime, 0.92)
          const byteString = atob(dataUrl.split(',')[1])
          const ab = new ArrayBuffer(byteString.length)
          const ia = new Uint8Array(ab)
          for (let i = 0; i < byteString.length; i++) ia[i] = byteString.charCodeAt(i)
          const blob = new Blob([ab], { type: mime })
          resolve(URL.createObjectURL(blob))
        }
      })
    }

    function enableDownload(url, format, filename) {
      lastBlobUrl = url
      lastFormat = format
      lastFilename = filename
      dlBtn.disabled = !lastBlobUrl
    }

    function safeDownload(url, filename) {
      // Надёжная загрузка для Safari/старых браузеров
      const a = document.createElement('a')
      a.href = url
      a.download = filename
      document.body.appendChild(a)
      a.click()
      a.remove()
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault()
      try {
        setStatus('')
        ensureLibReady()

        const text = dataEl.value.trim()
        if (!text) return

        const qr = buildQRMatrix(text)
        const fmt = formatEl.value
        const style = styleEl.value
        const file = sanitizeFilename(filenameEl.value)

        revokeLastUrl()
        dlBtn.disabled = true
        genBtn.disabled = true
        setStatus('Генерация…')

        if (fmt === 'svg') {
          const svg = makeCustomSVG(qr, style)
          setPreview(svg)
          const blob = new Blob([new XMLSerializer().serializeToString(svg)], { type: 'image/svg+xml' })
          const url = URL.createObjectURL(blob)
          enableDownload(url, 'svg', file)
        } else {
          const target = parseInt(sizeEl.value, 10) || 1024
          const canvas = drawCanvas(qr, Math.min(Math.max(target, 128), 4096), style)
          setPreview(canvas)
          const mime = fmt === 'jpg' ? 'image/jpeg' : 'image/png'
          const url = await canvasToBlobUrl(canvas, mime)
          enableDownload(url, fmt, file)
        }
        setStatus('Готово — можно скачивать')
      } catch (err) {
        console.error(err)
        alert('Не удалось сгенерировать QR. Попробуй обновить страницу.')
        setStatus('Ошибка')
      } finally {
        genBtn.disabled = false
      }
    })

    dlBtn.addEventListener('click', () => {
      if (!lastBlobUrl) return
      safeDownload(lastBlobUrl, `${lastFilename || 'qr-code'}.${lastFormat || formatEl.value}`)
    })

    // UX: Enter в поле ссылки генерирует QR
    dataEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault()
        genBtn.click()
      }
    })
  })()
  </script>
</body>
</html>
